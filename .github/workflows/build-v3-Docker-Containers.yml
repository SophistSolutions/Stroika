#
# Windows not yet working, but otherwise seems to work OK to automate build/upload of tagged docker images
#
name: build-v3-Docker-Containers

on:
  workflow_dispatch:
    inputs:
      ignored:
        description: "ignored"
        required: false
        default: ""

jobs:
  build-Linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build System Info
        shell: "bash"
        run: |
          echo "CWD: `pwd`"
          df -h
          uname -a
          echo "DetectedHostOS: `./ScriptsLib/DetectedHostOS`"
      - name: Build Linux Container Images
        run: |
          DEBIAN_FRONTEND=noninteractive make --directory DockerBuildContainers pull-base-images
          DEBIAN_FRONTEND=noninteractive make --directory DockerBuildContainers build-images
          DEBIAN_FRONTEND=noninteractive make --directory DockerBuildContainers tag-images
      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Push Linux Container Images
        run: |
          DEBIAN_FRONTEND=noninteractive make --directory DockerBuildContainers push-images

  build-Windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build System Info
        shell: "bash"
        run: |
          echo "CWD: `pwd`"
          df -h
          uname -a
          systeminfo
          which bash
          echo "DetectedHostOS: `./ScriptsLib/DetectedHostOS`"
          echo NUMBER_OF_PROCESSORS=$NUMBER_OF_PROCESSORS
      - name: Update PATH (wrong bash in path by default, sad seems hard to update path in github actions)
        shell: "cmd"
        run: |
          echo PATH=%PATH%
          echo GITHUB_PATH=%GITHUB_PATH%
          echo "c:/Program Files/git/usr/bin/" >> tmpPathUpdate
          type %GITHUB_PATH% >> tmpPathUpdate
          copy tmpPathUpdate %GITHUB_PATH%
          del tmpPathUpdate
          echo "wherebash:" && where bash
          set PATH="c:/Program Files/git/usr/bin/;%PATH%"
          echo "wherebash:" && where bash
      - name: Build Windows Container Images
        shell: "bash"
        run: |
          echo "wherebash:" && which bash
          make --directory DockerBuildContainers pull-base-images
          make --directory DockerBuildContainers build-images
          make --directory DockerBuildContainers tag-images
      - name: Build Windows Container Images
        shell: "cmd"
        run: |
          echo "wherebash:" && where bash
          make --directory DockerBuildContainers pull-base-images
          make --directory DockerBuildContainers build-images
          make --directory DockerBuildContainers tag-images
      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Push Windows Container Images
        run: |
          make --directory DockerBuildContainers push-images
