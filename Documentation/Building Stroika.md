# Building Stroika

---

## Common

Stroika is a C++ class library. The only fully supported build environment for Stroika is GNU Make. Once you have that setup, you can build through your favorite IDE.

This build process is cross-platform. It supports cross-compiling, and builds on visual studio.net (windows), and Linux.

---

## <a name="Quick-Start">Quick Start</a>

```bash
wget https://github.com/SophistSolutions/Stroika/archive/v2.1-Release.tar.gz
tar xf v2.1-Release.tar.gz && mv Stroika-2.1-Release Stroika-Dev
```

or

```bash
git clone https://github.com/SophistSolutions/Stroika.git Stroika-Dev
```

followed by:

```bash
make --directory Stroika-Dev all run-tests
```

Or, for a depending on your system, for a quicker turnaround, perhaps:
```bash
make --directory Stroika-Dev all run-tests CONFIGURATION=Debug -j10
```


If you have a relatively standard POSIX like c++ build environement, you maybe done at this point. If you got errors, or want to know more, read on.

### Build with Docker

If you are missing any components and just want a quick environment to test that has all the right build components installed, you can use the pre-built docker containers:

UNIX:

```bash
docker run -it sophistsolutionsinc/stroika-buildvm-ubuntu2004-small
cat Getting-Started-With-Stroika.md
```

Windows:

```bash
docker run -it sophistsolutionsinc/stroika-buildvm-windows-cygwin-vs2k19
cat Getting-Started-With-Stroika.md
```

### **_Note_**

It takes a while to build all of Stroika (10-20 minutes per configuration), so adding -j10 (or so) helps a lot.

---

## More Details on Getting Started

### Install required tools

This mostly conists of the standard UNIX build tools.

Roughly:
- c++ compiler supporting C++17 or later
- bash (sh)
- make (gnu make), patch, perl, pkg-config, realpath, sed, tar, tr, wget, unzip
- 7za, cmake (optionally - for building some optional components)


You may find it helpful to review the instructions in [Installing-Required-Tools.md](./Installing-Required-Tools.md) which layout details per development platform.

### Things to try (explore)

- `make help`

  Not needed, but gives some idea of make options.

- `make check-prerequisite-tools`

  Not needed, but tells you if you are missing anything critical.

- `make default-configurations`

  Not needed, but it&#39;s a springboard for setting up the configuration you want.

  Review ConfigurationFiles/Debug.xml or any of the other default configuration files

---

## The **configure** script

Like many non-trivial C/C++ libraries, you run configure to establish some build parameters, before invoking make. But unlike most such configuration systems, Stroika creates 'named' configurations, and facilitates building multiple such named configurations at once.

Each configuration is stored in in a file named \${CONFIGNAME}.xml in the top-level `ConfigurationFiles/` directory.

- Examples of generating configurations
  - `./configure Debug-x86 --config-tag Windows --config-tag x86 --arch x86 --apply-default-debug-flags`
  - `./configure Debug --config-tag Unix --apply-default-debug-flags`
  - `./configure clang++-6-release-libstdc++ --config-tag Unix --compiler-driver clang++-6.0 --apply-default-release-flags --stdlib libstdc++ --trace2file enable`
  - `CXX=clang++ ./configure Debug-clang --config-tag Unix --apply-default-debug-flags`
  - `./configure g++-valgrind-debug-SSLPurify --config-tag Unix --config-tag valgrind -valgrind enable --openssl use --openssl-extraargs purify --apply-default-debug-flags --sanitize none;`

### Configuration File Format

Simple XML format (@todo provide XSD).
The command-line used to generate the configuration is the first element of the XML file, so its easy to regenerate the configuration with whatever slight variation you wish.

#### Example Configuration file

```xml
<!--This file autogenerated by the configure command: see Configure-Command-Line, modify it, and re-run-->

<Configuration>
    <Configure-Command-Line>configure Debug-x86 --platform VisualStudio.Net-2022 --config-tag Windows --config-tag x86 --arch x86 --build-by-default MSYS --apply-default-debug-flags</Configure-Command-Line>
    <ProjectPlatformSubdir>VisualStudio.Net-2022</ProjectPlatformSubdir>
    <BUILD_TOOLS_ROOT>C:/Program Files/Microsoft Visual Studio/2022/Community</BUILD_TOOLS_ROOT>
    <TARGET_PLATFORMS>Windows</TARGET_PLATFORMS>
    <ARCH>x86</ARCH>
    <ConfigTags>Windows x86</ConfigTags>
    <BuildByDefault>MSYS</BuildByDefault>
    <AS>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x86/ml.exe</AS>
    <CC>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x86/cl.exe</CC>
    <CXX>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x86/cl.exe</CXX>
    <MIDL>C:/Program Files (x86)/Windows Kits/10/bin/10.0.19041.0/x64/midl.exe</MIDL>
    <RC>C:/Program Files (x86)/Windows Kits/10/bin/10.0.19041.0/x64/rc.exe</RC>
    <ExtraMakeDefines>
    </ExtraMakeDefines>
    <PkgConfigLinkLineAppendages>
    </PkgConfigLinkLineAppendages>
    <ENABLE_ASSERTIONS>1</ENABLE_ASSERTIONS>
    <qFeatureFlag_ActivePerl>use</qFeatureFlag_ActivePerl>
    <qFeatureFlag_boost>use</qFeatureFlag_boost>
    <qFeatureFlag_LibCurl>no</qFeatureFlag_LibCurl>
    <qFeatureFlag_OpenSSL>use</qFeatureFlag_OpenSSL>
    <qFeatureFlag_WinHTTP>use-system</qFeatureFlag_WinHTTP>
    <qFeatureFlag_ATLMFC>use-system</qFeatureFlag_ATLMFC>
    <qFeatureFlag_Xerces>use</qFeatureFlag_Xerces>
    <qFeatureFlag_ZLib>use</qFeatureFlag_ZLib>
    <qFeatureFlag_sqlite>use</qFeatureFlag_sqlite>
    <qFeatureFlag_LZMA>use</qFeatureFlag_LZMA>
    <qFeatureFlag_WIX>use</qFeatureFlag_WIX>
    <CPPFLAGS>-I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/ATLMFC/include" -I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/include" -I"C:/Program Files (x86)/Windows Kits/NETFXSDK/4.8/include/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/ucrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/shared" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/winrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/cppwinrt" -I"C:/Sandbox/Stroika/DevRoot/Builds/Debug-x86/ThirdPartyComponents/include/" -I"C:/Sandbox/Stroika/DevRoot/Library/Sources/" -I"C:/Sandbox/Stroika/DevRoot/IntermediateFiles/Debug-x86/" -D_UNICODE -DUNICODE -D_WINDOWS -D_DEBUG -DqDebug=1 -DqHasFeature_LibCurl=0 -DqHasFeature_OpenSSL=1 -DqHasFeature_WinHTTP=1 -DqHasFeature_ATLMFC=1 -DqHasFeature_Xerces=1 -DqHasFeature_ZLib=1 -DqHasFeature_sqlite=1 -DqHasFeature_LZMA=1 -DqHasFeature_boost=1 -DqTraceToFile=1 -DqDefaultTracingOn=1</CPPFLAGS>
    <CFLAGS>-I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/ATLMFC/include" -I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/include" -I"C:/Program Files (x86)/Windows Kits/NETFXSDK/4.8/include/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/ucrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/shared" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/winrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/cppwinrt" -I"C:/Sandbox/Stroika/DevRoot/Builds/Debug-x86/ThirdPartyComponents/include/" -I"C:/Sandbox/Stroika/DevRoot/Library/Sources/" -I"C:/Sandbox/Stroika/DevRoot/IntermediateFiles/Debug-x86/" -EHsc -nologo -GR -Gd -W4 -Zc:inline -FC -bigobj -RTCsu -GS -Oy- -Od -MTd -Z7 -D_UNICODE -DUNICODE -D_WINDOWS -D_DEBUG -DqDebug=1 -DqHasFeature_LibCurl=0 -DqHasFeature_OpenSSL=1 -DqHasFeature_WinHTTP=1 -DqHasFeature_ATLMFC=1 -DqHasFeature_Xerces=1 -DqHasFeature_ZLib=1 -DqHasFeature_sqlite=1 -DqHasFeature_LZMA=1 -DqHasFeature_boost=1 -DqTraceToFile=1 -DqDefaultTracingOn=1  -fsanitize=address</CFLAGS>
    <CXXFLAGS>-std:c++latest -I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/ATLMFC/include" -I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/include" -I"C:/Program Files (x86)/Windows Kits/NETFXSDK/4.8/include/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/ucrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/shared" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/winrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/cppwinrt" -I"C:/Sandbox/Stroika/DevRoot/Builds/Debug-x86/ThirdPartyComponents/include/" -I"C:/Sandbox/Stroika/DevRoot/Library/Sources/" -I"C:/Sandbox/Stroika/DevRoot/IntermediateFiles/Debug-x86/" -EHsc -nologo -GR -Gd -W4 -Zc:inline -FC -bigobj -RTCsu -GS -Oy- -Od -MTd -Z7 -D_UNICODE -DUNICODE -D_WINDOWS -D_DEBUG -DqDebug=1 -DqHasFeature_LibCurl=0 -DqHasFeature_OpenSSL=1 -DqHasFeature_WinHTTP=1 -DqHasFeature_ATLMFC=1 -DqHasFeature_Xerces=1 -DqHasFeature_ZLib=1 -DqHasFeature_sqlite=1 -DqHasFeature_LZMA=1 -DqHasFeature_boost=1 -DqTraceToFile=1 -DqDefaultTracingOn=1  -fsanitize=address</CXXFLAGS>
    <SanitizerFlags>address </SanitizerFlags>
    <INCLUDES_PATH>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/ATLMFC/include;C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/include;C:/Program Files (x86)/Windows Kits/NETFXSDK/4.8/include/um;C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/ucrt;C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/shared;C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/um;C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/winrt;C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/cppwinrt;C:/Sandbox/Stroika/DevRoot/Builds/Debug-x86/ThirdPartyComponents/include/;C:/Sandbox/Stroika/DevRoot/Library/Sources/;C:/Sandbox/Stroika/DevRoot/IntermediateFiles/Debug-x86/</INCLUDES_PATH>
    <CrossCompiling>false</CrossCompiling>
    <IncludeDebugSymbolsInLibraries>1</IncludeDebugSymbolsInLibraries>
    <IncludeDebugSymbolsInExecutables>1</IncludeDebugSymbolsInExecutables>
    <TOOLS_PATH_ADDITIONS>C:/Program Files (x86)/HTML Help Workshop;C:/Program Files (x86)/Microsoft SDKs/Windows/v10.0A/bin/NETFX 4.8 Tools/x64/;C:/Program Files (x86)/Microsoft Visual Studio/Shared/Common/VSPerfCollectionTools/vs2019/;C:/Program Files (x86)/Windows Kits/10/bin/10.0.19041.0/x64;C:/Program Files (x86)/Windows Kits/10/bin/x64;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/CommonExtensions/Microsoft/CMake/CMake/bin;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/CommonExtensions/Microsoft/FSharp/Tools;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/CommonExtensions/Microsoft/TeamFoundation/Team Explorer;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/CommonExtensions/Microsoft/TestWindow;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/Extensions/Microsoft/IntelliCode/CLI;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/VC/Linux/bin/ConnectionManagerExe;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/IDE/VC/VCPackages;C:/Program Files/Microsoft Visual Studio/2022/Community/Common7/Tools/;C:/Program Files/Microsoft Visual Studio/2022/Community/MSBuild/Current/Bin/amd64;C:/Program Files/Microsoft Visual Studio/2022/Community/MSBuild/Current/bin/Roslyn;C:/Program Files/Microsoft Visual Studio/2022/Community/Team Tools/Performance Tools;C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x64;C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x86;C:/Windows/Microsoft.NET/Framework64/v4.0.30319)</TOOLS_PATH_ADDITIONS>
    <LIBS_PATH>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/ATLMFC/lib/x86;C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/lib/x86;C:/Program Files (x86)/Windows Kits/NETFXSDK/4.8/lib/um/x86;C:/Program Files (x86)/Windows Kits/10/lib/10.0.19041.0/ucrt/x86;C:/Program Files (x86)/Windows Kits/10/lib/10.0.19041.0/um/x86;C:/Sandbox/Stroika/DevRoot/Builds/Debug-x86/ThirdPartyComponents/lib/</LIBS_PATH>
    <LIB_DEPENDENCIES>xerces-c_3D.lib lzma.lib sqlite.lib zlib.lib urlmon.lib rpcrt4.lib kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib odbccp32.lib </LIB_DEPENDENCIES>
    <EXTRA_PREFIX_LINKER_ARGS> -nologo -MACHINE:x86 -DEBUG</EXTRA_PREFIX_LINKER_ARGS>
    <EXTRA_SUFFIX_LINKER_ARGS></EXTRA_SUFFIX_LINKER_ARGS>
    <AR></AR>
    <LIBTOOL>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x86/lib.exe</LIBTOOL>
    <RANLIB></RANLIB>
    <Linker>C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/bin/HostX64/x86/link.exe</Linker>
    <STRIP></STRIP>
    <RUN_PREFIX></RUN_PREFIX>
</Configuration>
```

### Configuration Basic Concepts

- Each configuration has a name (e.g. Debug, Release-clang-7, Debug-raspberry-pi, Release-Centos-6, etc)
- Each configuration can have multiple 'tags' - like Unix, Windows, x86, arm, etc - which can be used to build sets of configurations
- Each configuration defines CFLAGS and CXXFLAGS and (explain others) variables used in a regular makefile. You define (on the command line) variables (like 'assertions') which are used to generate to generate a bunch of other variables which appear in configuration files.

### Configure Command-line reference

```text
Help for making Stroika:
Targets:
    all:                         -    Builds everything
    check:                       -    Checks everything was built properly
    clean:
    clobber:
    reconfigure:                 -    Rebuild configuration files from the command-lines that built them before
    libraries:                   -    Builds Stroika foundation & frameworks, and any things it depends on (like third-party-components)
    project-files:               -    Alias for project-files-visual-studio project-files-qt-creator
    project-files-visual-studio: -    Builds project files for visual studio.net
    project-files-qt-creator(*): -    Builds project project-files-qt-creator (also project-files-qt-creator-load
                                      project-files-qt-creator-save)
    tests:
    format-code:                 -    Run astyle on source code, and update it to conform to Stroika code formatting standards
    samples:
    documentation:
    third-party-components:
    run-tests:                   -    [REMOTE=] - eg. REMOTE=lewis@localhost;
                                      [VALGRIND=memcheck or helgrind, etc] to run with valgrind
                                      (EXTRA_VALGRIND_OPTIONS= can be used with valgrind)
                                      OR VALGRIND_SUPPRESSIONS="Valgrind-MemCheck-Common.supp Valgrind-MemCheck-BlockAllocation.supp"
                                      OR VALGRIND_SUPPRESSIONS="Valgrind-Helgrind-Common.supp"
                                      EG: VALGRIND_SUPPRESSIONS="Valgrind-Helgrind-Common.supp" make VALGRIND=helgrind run-tests
    apply-configurations:        -    Force re-creation implied files / links for any configurations in the Configurations
                                      folder (not needed, automatic)
    default-configurations:      -    Creates the default configurations in Configurations folder; see ./configure -help for environment variables
                                      e.g. EXTRA_CONFIGURE_ARGS='--openssl-extraargs purify --block-allocation disable' make default-configurations
                                      OR EXTRA_CONFIGURE_ARGS='--platform VisualStudio.Net-2019' make default-configurations
                                      OR PLATFORM='VisualStudio.Net-2022' make default-configurations
    list-configurations:         -    prints all available configurations (each can be used as arg to CONFIGURAITON= make lines)
    list-configuration-tags:     -    prints a list of all configurtion tags (configuration tags impute groups of configurations)
    check-prerequisite-tools:    -    Check the tools needed to build Stroika are installed.
Special Variables:               -    Extra params you can pass to the make line that may help...
    CONFIGURATION=XYZ            -    Causes only the configuration XYZ to have the targetted goal applied (e.g. make all CONFIGURATION=Debug)
    CONFIGURATION_TAGS=TAGS      -    Causes only the configurations with tags TAGS to have the targetted goal applied (e.g. make all CONFIGURATION_TAGS=Windows)
                                      NB: TAGS is a handy shortcut for CONFIGURAITON_TAGS, so you can say make all TAGS="Windows 64"
    ECHO_BUILD_LINES=1           -    Causes make lines to be echoed which can help makefile debugging
    MAKE_INDENT_LEVEL=0          -    Helpful to neaten formatting when multiple levels of makes calling Stroika make
    QUICK_BUILD=1                -    Defaults=0, but if =1, skip some optional build steps (like openssl tests, CURRENT folders; used for some CI testing)
    TEST_FAILURES_CAUSE_FAILED_MAKE=0
                                      only applies to make run-tests, and prevents test failures from stopping make (like make -k on run-tests)
```

### Amending a configuration

Configuration files should **not** be edited by hand. Instead, the current command line is the first element of the configuration file: take that as a starting point and ammend it as needed, and re-run **make apply-configurations** or **make CONFIGURATION=X apply-configuration**.

### Environment variables that affect generation of configuration

- CC, CXX, PLATFORM, ARCH, AS, AR, RANLIB, STRIP

The reason this is so important, is that it allows an external build system like bitbake, or node-gyp, etc to define parameters for a build, and easily generate appropriate configurations.

### Printing configure variables from a script

#### Examples

- `./ScriptsLib/GetConfigurationParameter Debug CFLAGS`

  -I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/ATLMFC/include" -I"C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/MSVC/14.30.30705/include" -I"C:/Program Files (x86)/Windows Kits/NETFXSDK/4.8/include/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/ucrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/shared" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/um" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/winrt" -I"C:/Program Files (x86)/Windows Kits/10/include/10.0.19041.0/cppwinrt" -I"C:/Sandbox/Stroika/DevRoot/Builds/Debug/ThirdPartyComponents/include/" -I"C:/Sandbox/Stroika/DevRoot/Library/Sources/" -I"C:/Sandbox/Stroika/DevRoot/IntermediateFiles/Debug/" -EHsc -nologo -GR -Gd -W4 -Zc:inline -FC -bigobj -RTCsu -GS -Oy- -Od -MTd -Z7 -D_UNICODE -DUNICODE -D_WINDOWS -D_DEBUG -DqDebug=1 -DqHasFeature_LibCurl=0 -DqHasFeature_OpenSSL=1 -DqHasFeature_WinHTTP=1 -DqHasFeature_ATLMFC=1 -DqHasFeature_Xerces=1 -DqHasFeature_ZLib=1 -DqHasFeature_sqlite=1 -DqHasFeature_LZMA=1 -DqHasFeature_boost=1 -DqTraceToFile=1 -DqDefaultTracingOn=1  -fsanitize=address

- `./ScriptsLib/GetConfigurationParameter Debug Linker`

  g++

- `./ScriptsLib/GetConfigurationParameter Release CXXFLAGS`

  -flto --std=c++17 -O3 -I/mnt/c/Sandbox/Stroika/DevRoot/Builds/Release/ThirdPartyComponents/include/ -I/mnt/c/Sandbox/Stroika/DevRoot/Library/Sources/ -I/mnt/c/Sandbox/Stroika/DevRoot/IntermediateFiles/Release/ -Wall -Wno-switch -Wno-sign-compare -Wno-unused-variable -Wno-unused-value -Wno-strict-aliasing -Wno-comment -Wno-unused-function -Wno-unused-but-set-variable -Wno-unused-local-typedefs -g

---

## Static Linking vs. Dynamic Libraries

Stroika itself is only provided as a static library. This is because static libraries are much simpler, better for optimizing, and more flexible about configuraiton of the particular build options desired.

I cannot rule out ever providing a dynamic link option/feature, but I see exceedingly little point to it.

Of course, you can still use dynamic (shared library) linking however you wish for any components you build (like you can build shared libraries with Stroika), and obviously for most operatiing systems, the libraries your apps must like to are shared libraries.

But this bias towards static linking is reflected in all the defaults and samples provided with Stroika.

---

## Third Party Components

Stroika builds on, and neatly integrates functionality from several third-party compoenents. These components are automatically downloaded and built and integrated into Stroika (depending on configuration) or Stroika can be configured to use the system installed version of these components.

- ActivePerl (special case, just a hack to be able to build openssl)
- boost
- curl
- openssl
- lzma SDK
- sqlite
- WIX
- xerces
- zlib

---

## Build Results

Intermediate files (objs etc) go into

- **IntermediateFiles/{CONFIGURATION-NAME}**.

Final build products (libraries and executables) go into

- **Builds/{CONFIGURATION-NAME}**.

---

## Build Process

On any platform, building Stroika, and all is demo applications and regression tests is as simple as cd&#39;ing to the top-level directory, and typing make

### Special Targets

- `make`

  Make with no arguments runs &#39;make help&#39;

- `make help`

  Prints the names and details of the special targets

- `make all`

  Builds the stroika library, tests, demos, etc.

- `make libraries`

  Builds just the Stroika libraries

- `make samples`

  Builds the Stroika sample applications

- `make run-tests`
- `make CONFIGURATION=zyx run-tests REMOTE='lewis@raspberrypi'`
- `make CONFIGURATION=abc run-tests VALGRIND=memcheck`

  Builds Stroika, and all the regression tests, and runs the regression tests. If REMOTE= is specified, the code is copied to the target machine with ssh, and the test run there (helpful for when cross-compiling). VALGRIND= is used to run memcheck, leakcheck, or helgrind on the given configuraiton.

- make `project-files`

  Builds project files which can be used for things like visual studio (not needed)

- `make check-prerequisite-tools`

  Checks if the tools needed to build Stroika are installed and in your path. This is done automatically, and generally not needed explicitly.

- `make apply-configurations`

  To generate all the directories and files dependent on the defined configurations. Note – this is generally not necessary, and called automatically.

### CONFIGURATION arguments to make

All the make targets (e.g. all, libraries etc) take an OPTIONAL parameter CONFIGURATION. If specified, only that configuration is built. If omitted (or empty) – ALL configurations are built.

### TAGS arguments to make

This allows for building (or clobbering or whatever) a related family of configurations. For example

- `make TAGS=Windows`

  runs all the windows builds.

- `make TAGS=Unix` all

  runs all the UNIX compiles

- `make TAGS="Windows x86" all`

  This builds all the configurations with BOTH the Windows and x86 tag (so all the 32-bit x86 builds)

- `make TAGS="Unix arm" list-configurations`

  This doesn't build anything, but just lists all the matching configurations.

- `make list-configurations`
- `make list-configuration-tags`
- `make list-configurations TAGS="Windows"`
- `make list-configurations TAGS="Windows x86_64"`

### Other Make variables that can be helpful

- ECHO_BUILD_LINES=1 makes the output of make noisier, so you can run particular builds by hand, or debug the make process.
- MAKE_INDENT_LEVEL=N, is useful when calling the stroika make process as part of another larger make process, to get its output indended.

### Cross-Compiling

#### Building for Raspberry Pi

To cross-compile for Raspberry pi,

- install some suitable cross compiler (in this example arm-linux-gnueabihf-g++-9)

On unubtu, sudo apt-get install g++-9-arm-linux-gnueabihf

- configure raspberrypi-gcc-9 --apply-default-debug-flags --trace2file enable --compiler-driver arm-linux-gnueabihf-g++-9 --cross-compiling true

Set cross-compiling true so that internal tests aren&#39;t run using the arm built executables.

Set –apply-default-release-flags instead of &#39;debug&#39; for a smaller faster executable.

--trace2file disable to disable tracefile utility, and enabled writes a debug log to /tmp.

- make CONFIGURATION=raspberrypi-gcc-9 all

This builds the samples, libraries etc to Builds/raspberrypi-gcc-9)

- make run-tests REMOTE=pi@myRasberryPi

This uses ssh to run the tests remotely on the argument machine (I setup a hostname in /etc/hosts for the mapping).

Using SSH, it&#39;s also helpful to setup ssh keys to avoid re-entering passwords

[http://sshkeychain.sourceforge.net/mirrors/SSH-with-Keys-HOWTO/SSH-with-Keys-HOWTO-4.html](http://sshkeychain.sourceforge.net/mirrors/SSH-with-Keys-HOWTO/SSH-with-Keys-HOWTO-4.html)

---

## Integration with IDEs

### Using Visual Studio.net

Visual Studio.net project and solution files are available for the Stroika demos, top-level project files, and regression tests. Once you have built your configuration files (see above), you can use the project files to build, test, extend and develop Stroika.

Stroika's build process automatically populates a property file

~~~
Library/Projects/VisualStudio.Net/Microsoft.Cpp.stroika.AllConfigs.props
~~~

This contains lots of interesting stuff (used to drive intellisense etc) and is automatically included by the provided Stroika projects.
And it includes two important macros (set reasonably by default, but that you may want to override):

~~~
<StroikaBuildToolsExtraPath>c:\msys64\usr\bin;c:\cygwin64\bin</StroikaBuildToolsExtraPath>
<JOBS_FLAG>-j 8</JOBS_FLAG>
~~~

### Using Visual Studio Code

Visual Studio Code works well with Stroika. Just open the workspace file Workspaces/VSCode/Stroika.code-workspace.
The workspsace contains pre-built 'tasks' to build Stroika (run makefiles).

### Using QtCreator (on unix)

Run Library/Projects/QtCreator/CreateQtCreatorSymbolicLinks.sh to create project files at the top level of your Stroika directory. Then you can open that .creator file in qtCreator, and build and debug Stroika-based applications.

---

## But Why? Build / Configuration Design

### Alternatives

We seriously considered a number of build systems, including cmake, ant, perl scripts, qmake, etc. They all had substantial weaknesses, with ant possibly being the best alternative, except that it&#39;s heavily java oriented. Maybe for c++ cmake would have been the best?

But just plain GNU make – appears to be a nearly universally available alternative, very standard and simple, so that&#39;s what we&#39;re doing.

But - even with just plain make, you need some sort of configure script to establish what compiler options will be defined. Again, lots of different alternatives here, but in the end I decided to just build custom scripts which build a very simple XML configuration declaration, and which drives the make process by #included 'config' makefile.

---

## Common Errors

- Tar failure

  Errors about invalid parameters, and/or bad blocks can usually be fixed by installing a copy of gnu tar. We&#39;ve tested 1.27.

- cp: illegal option –

  Install a copy of GNU cp

- Cannot find &#39;blah&#39; in Cygwin

  If you are trying to install required components in Cygwin, and cannot find them in the Cygwin setup GUI, try:

  cygcheck -p dos2unix

- On raspberry pi

  > /tmp/Test43: /lib/arm-linux-gnueabihf/libc.so.6: version `GLIBC_2.28' not found (required by /tmp/Test43)

  - fix by

    - sudo vi /etc/apt/sources.list"
    - temporarily add

      ```bash
      #tmphack to load GLIBC_2 2.28
      deb http://raspbian.raspberrypi.org/raspbian/ buster main contrib non-free rpi
      ```

    - `sudo apt-get update`
    - `apt-cache policy libc6`
    - `sudo apt-get install libc6=2.28-5+rpi1`
    - undo edit to /etc/apt/sources.list (or comment out addition)
    - sudo apt-get update

    NOTE - if you area dealing later versions some variation on this will likely work. Select the next debian release past your current one for the /etc/apt/sources.list addition and use apt-cache policy to find an available version.

- On MacOS

  - Brew issues

    ```sh
    ld: library not found for -lidn2
    ```

    - brew install libidn2

    - and maybe also add to .zshenv

    ```sh
    export CPATH=/opt/homebrew/include
    export LIBRARY_PATH=/opt/homebrew/lib
    ```

- Under Docker

  ```text
  ==7192==LeakSanitizer has encountered a fatal error.
  ==7192==HINT: For debugging, try setting environment variable LSAN_OPTIONS=verbosity=1:log_threads=1
  ==7192==HINT: LeakSanitizer does not work under ptrace (strace, gdb, etc)
  ```

  OR

  ```text
  warning: Error disabling address space randomization: Operation not permitted
  warning: Could not trace the inferior process.
  warning: ptrace: Operation not permitted
  ```

  run the docker container (docker run or docker exec line) - with:
  `--security-opt seccomp=unconfined`

  - See also
    [../ScriptsLib/RunInDockerEnvironment](../ScriptsLib/RunInDockerEnvironment)
    for more hints on developing flags with docker containers.
