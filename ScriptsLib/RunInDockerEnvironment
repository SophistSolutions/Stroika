#!/bin/bash

StroikaRoot="${StroikaRoot:=`realpath ~/Sandbox/Stroika-Dev`}"
CONTAINER_NAME="${CONTAINER_NAME:-regression-tests}"
CONTAINER_IMAGE="${CONTAINER_IMAGE:-sophistsolutionsinc/stroika-buildvm-ubuntu1804-regression-tests}"
EXTRA_DNS="${EXTRA_DNS:-192.168.244.1}"

### Can set CMD2RUN=./ScriptsLib/RegressionTests.sh
CMD2RUN="${CMD2RUN:-bash}"

# Silently remove the previous version of the container if it was there before
docker stop ${CONTAINER_NAME} >& /dev/null || true
docker rm ${CONTAINER_NAME} >& /dev/null || true

# -u and -v /etc/password etc is so username passed through and shows up in ui (name not number)

# -v $HOME:$HOME so we can can re-use/and build to - the my- versions of compilers and cache/re-use those

# -v $HOME/.ssh:$HOME/.ssh:ro so connect to raspberrypi can use ssh keys

# --dns lines since the default for a container is to use global (google) dns server, which doesn't have local dns entries (like raspberrypi device)

# -security-opt seccomp=unconfined  needed to run some google sanitizers (and probbaly to debug?/valgrind?)

# -e COLUMNS=\"`tput cols`\" -e LINES=\"`tput lines`\" doesn't work perfectly, but better than completely shitty display of # of lines 
#  which appears to be the docker default


docker run \
	-u`id -u`:`id -g` -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro \
	-v $HOME/.ssh:$HOME/.ssh:ro \
	-v /private-compiler-builds:/private-compiler-builds \
	--dns ${EXTRA_DNS} --dns 8.8.8.8 \
	--security-opt seccomp=unconfined \
	-it\
	-e COLUMNS=\"`tput cols`\" -e LINES=\"`tput lines`\" \
	--name ${CONTAINER_NAME} \
	-h ${CONTAINER_NAME} \
	-v $StroikaRoot:/Sandbox-StroikaRoot \
	-w /Sandbox-StroikaRoot \
	${CONTAINER_IMAGE} \
	${CMD2RUN}
